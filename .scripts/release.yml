parameters:
  - name: DependsOn
    type: string
    default: Build

  - name: PublishAlpha
    type: boolean
    default: false

  - name: LinuxPool
    type: string
    default: azsdk-pool-mms-ubuntu-1804-general

  - name: OSVmImage
    type: string
    default: ubuntu-18.04

stages:
  - ${{if eq(parameters.PublishAlpha, 'true')}}:
      - stage: Integration
        dependsOn: ${{parameters.DependsOn}}
        jobs:
          - deployment: PublishToGithub
            variables:
              TAR_NAME: $[ stageDependencies.BuildStage.Build.outputs['PackArtifacts.TAR_NAME'] ]
              DEV_VERSION: $[ stageDependencies.BuildStage.Build.outputs['PackArtifacts.DEV_VERSION'] ]
            environment: github
            displayName: Publish dev version to GitHub
            pool:
              name: ${{ parameters.LinuxPool }}
              vmImage: ${{ parameters.OSVmImage }}
            strategy:
              runOnce:
                deploy:
                  steps:
                    - script: |
                        export DEV_VERSION=$(node -p -e "require('./package.json').version")-alpha.$BUILD_BUILDNUMBER
                      displayName: "Get Dev Version"

                    - task: NodeTool@0
                      inputs:
                        versionSpec: "14.x"
                      displayName: "Install Node.js"
                    - task: DownloadBuildArtifacts@0
                      inputs:
                        downloadType: "single"
                        artifactName: packages
                        downloadPath: "$(System.ArtifactsDirectory)"
                    - script: |
                        echo "Publish $(System.ArtifactsDirectory)/packages/$(TAR_NAME) $(DEV_VERSION )"
                        ls $(System.ArtifactsDirectory)
                      displayName: "Publish to GitHub"
          - deployment: PublishToNpm
            variables:
              TAR_NAME: $[ stageDependencies.BuildStage.Build.outputs['PackArtifacts.TAR_NAME'] ]
            environment: npm
            displayName: Publish dev version to NPM
            pool:
              name: $[coalesce(variables['Pool'], '')]
              vmImage: $[coalesce(variables['OSVmImage'], '')]
            strategy:
              runOnce:
                deploy:
                  steps:
                    - checkout: self
                    - task: NodeTool@0
                      inputs:
                        versionSpec: "14.x"
                      displayName: "Install Node.js"
                    - task: DownloadBuildArtifacts@0
                      inputs:
                        downloadType: "single"
                        artifactName: packages
                        downloadPath: "$(System.ArtifactsDirectory"
                    - script: |
                        echo "//registry.npmjs.org/:_authToken=$(azure-sdk-npm-token)" > ./.npmrc
                        npm publish --dry-run $(System.ArtifactsDirectory)/packages/$(TAR_NAME) --access-level="public" --registry="https://registry.npmjs.org/" --always-auth=true --tag="dev"
                      displayName: "Publish to NPM"
