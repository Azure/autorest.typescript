parameters:
  - name: DependsOn
    type: string
    default: Build

  - name: PublishAlpha
    type: boolean
    default: false

  - name: LinuxPool
    type: string
    default: azsdk-pool-mms-ubuntu-1804-general

  - name: OSVmImage
    type: string
    default: ubuntu-18.04

  - name: TAR_NAME
    type: string

  - name: DEV_VERSION
    type: string

stages:
  - ${{if eq(parameters.PublishAlpha, 'true')}}:
      - stage: Integration
        dependsOn: ${{parameters.DependsOn}}
        jobs:
          - deployment: PublishToGithub
            dependsOn: Pack
            environment: github
            displayName: Publish dev version to GitHub
            pool:
              name: ${{ parameters.LinuxPool }}
              vmImage: ${{ parameters.OSVmImage }}
            strategy:
              runOnce:
                deploy:
                  steps:
                    - task: NodeTool@0
                      inputs:
                        versionSpec: "14.x"
                      displayName: "Install Node.js"
                    - task: DownloadBuildArtifacts@0
                      inputs:
                        downloadType: "single"
                        artifactName: ${{ parameters.TAR_NAME }}
                        downloadPath: "$(System.ArtifactsDirectory)"
                    - script: |
                        echo "Publish $(System.ArtifactsDirectory)/${{ parameters.TAR_NAME }} ${{ parameters.DEV_VERSION }}"
                        ls $(System.ArtifactsDirectory)
                      displayName: "Publish to GitHub"
          - deployment: PublishToNpm
            environment: npm
            displayName: Publish dev version to NPM
            dependsOn: Pack
            variables:
              TAR_NAME: $[ dependencies.Pack.outputs['TAR_NAME'] ]
            pool:
              name: $[coalesce(variables['Pool'], '')]
              vmImage: $[coalesce(variables['OSVmImage'], '')]
            strategy:
              runOnce:
                deploy:
                  steps:
                    - checkout: self
                    - task: NodeTool@0
                      inputs:
                        versionSpec: "14.x"
                      displayName: "Install Node.js"
                    - task: DownloadBuildArtifacts@0
                      inputs:
                        downloadType: "single"
                        artifactName: ${{ parameters.TAR_NAME }}
                        downloadPath: "$(System.ArtifactsDirectory"
                    - script: |
                        echo "//registry.npmjs.org/:_authToken=$(azure-sdk-npm-token)" > ./.npmrc
                        npm publish --dry-run $(System.ArtifactsDirectory)/${{ parameters.TAR_NAME }} --access-level="public" --registry="https://registry.npmjs.org/" --always-auth=true --tag="dev"
                      displayName: "Publish to NPM"
